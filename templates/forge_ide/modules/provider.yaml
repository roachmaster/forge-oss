header:
  file: templates/forge_ide/generated/provider.yaml
  template: templates/forge_ide/provider.mustache
  type: provider_module
payload:
  # --------------------------------------------------------------------
  # PROVIDER MODULE
  # --------------------------------------------------------------------
  name: provider
  pub: true
  use: true
  desc: Forge provider registry â€” manages and dispatches ForgeIdeCommand instances
  isSchema: false
  isCommand: false
  isProvider: true
  isRouter: false
  ast:
    kind: provider_file
    version: 1.0
    namespace: forge_ide
    imports:
      - type: crate
        module: schema
        value: ForgeRequest, ForgeResponse
      - type: crate
        module: command
        value: ForgeIdeCommand, ForgeCommandKind
      - type: std
        module: collections
        value: HashMap
      - type: std
        module: sync
        value: Arc
    items:
      - name: ForgeProviderRegistry
        desc: Central registry for all Forge IDE command providers
        is_enum: false
        is_struct: true
        is_trait: false
        has_custom_methods: true
        fields:
          - name: providers
            type: HashMap<ForgeCommandKind, Arc<dyn ForgeIdeCommand>>
        impls:
          - name: new
            is_self_body: false
            returns_self_body: true
            sig_args: ""
            args: []
            returns: Self
            body:
              fields:
                - name: providers
                  value: HashMap::new()

          - name: register
            is_self_body: false
            async: false
            sig_args: "&mut self, kind: ForgeCommandKind, command: Arc<dyn ForgeIdeCommand>"
            args:
              - name: kind
                type: ForgeCommandKind
              - name: command
                type: Arc<dyn ForgeIdeCommand>
            returns: ()
            body:
              statements:
                - self.providers.insert(kind, command);

          - name: dispatch
            is_self_body: false
            async: true
            sig_args: "&self, request: &ForgeRequest"
            args:
              - name: request
                type: '&ForgeRequest'
            returns: ForgeResponse
            body:
              match:
                variable: request
                arms:
                  - pattern: ForgeRequest::RenderManifest
                    variant: Render
                  - pattern: ForgeRequest::BuildCrate
                    variant: Build
                  - pattern: ForgeRequest::GetEnv
                    variant: Env
                  - pattern: ForgeRequest::Custom
                    variant: Custom

          - name: list_registered
            is_self_body: false
            async: false
            sig_args: "&self"
            args: []
            returns: Vec<&'static str>
            body:
              chain:
                - variable: self.providers
                - call: values()
                - call: map(|c| c.name())
                - call: collect::<Vec<_>>()
